<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini Chat ‚Äì OpenAI API (demo local)</title>
  <style>
    :root { --bg:#0b0f13; --card:#121821; --ink:#e6edf3; --muted:#a0a6ad; --accent:#3b82f6; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:linear-gradient(180deg,#0b0f13,#0e141c); color:var(--ink);} 
    .wrap{ max-width:980px; margin:24px auto; padding:0 16px; }
    .card{ background:var(--card); border:1px solid #1e2633; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25);}    
    h1{ font-size:20px; margin:0 0 12px; }
    .grid{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media(min-width:840px){ .grid{ grid-template-columns: 1.2fr .8fr; } }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select, textarea{ width:100%; padding:10px 12px; background:#0c1219; color:var(--ink); border:1px solid #1c2431; border-radius:10px; outline:none; }
    textarea{ min-height:110px; resize:vertical; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; background:var(--accent); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .log{ height:420px; overflow:auto; padding:12px; background:#0a0f16; border:1px solid #111827; border-radius:12px; }
    .msg{ display:flex; gap:8px; margin-bottom:12px; }
    .badge{ font-size:11px; padding:2px 8px; border-radius:999px; background:#111827; color:#93c5fd; border:1px solid #1f2937; min-width:54px; text-align:center; }
    .content{ white-space:pre-wrap; line-height:1.45; }
    .muted{ color:var(--muted); font-size:12px; }
    .danger{ color:#fca5a5; }
    .ok{ color:#86efac; }
    .foot{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-top:8px; }
    .small{ font-size:12px; color:var(--muted); }
    .k{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" style="margin-bottom:12px">
      <h1>Mini Chat ‚Äì OpenAI API</h1>
      <div class="small">
        <b>Aviso r√°pido:</b> este arquivo funciona como <i>demo local</i>. Inserir sua chave da API diretamente no navegador <u>n√£o √© seguro</u>. Para uso real, configure um <b>backend proxy</b> (veja instru√ß√£o nos coment√°rios do c√≥digo).
      </div>
    </div>

    <div class="grid">
      <!-- Painel esquerdo: Mensagens -->
      <div class="card">
        <div class="row">
          <div>
            <label>Modelo</label>
            <select id="model">
              <option value="gpt-5">gpt-5</option>
              <option value="gpt-5-min">gpt-5-mini</option>
              <option value="gpt-5-nano">gpt-5-nano (barato)</option>
            </select>
          </div>
          <div>
            <label>Temperatura: <span id="tempv">0.7</span></label>
            <input id="temp" type="range" min="0" max="2" step="0.1" value="0.7" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>System prompt (opcional)</label>
            <input id="system" placeholder="ex.: Voc√™ √© um assistente √∫til e conciso." />
          </div>
          <div>
            <label>API(apenas para teste local)</label>
            <input id="" value="" />
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Sua mensagem</label>
          <textarea id="userText" placeholder="Pergunte qualquer coisa..."></textarea>
        </div>
        <div class="foot">
          <div class="small">Streaming ativado com <span class="k">/v1/chat/completions</span></div>
          <div>
            <button id="send" class="btn">‚ñ∂ Enviar</button>
            <button id="clear" class="btn" style="background:#334155">üßπ Limpar</button>
          </div>
        </div>
      </div>

      <!-- Painel direito: Log -->
      <div class="card">
        <label>Conversa</label>
        <div id="log" class="log" aria-live="polite"></div>
        <div class="small muted">Dica: pressione <span class="k">Ctrl+Enter</span> para enviar.</div>
      </div>
    </div>

    <div style="margin:16px 0" class="small muted">
      <b>Como usar</b>: cole sua chave (teste), escreva uma mensagem e clique em Enviar. Para produ√ß√£o, remova o campo de chave e use um endpoint do seu servidor (proxy) no lugar de <span class="k">api.openai.com</span>.
    </div>

    <div class="card">
      <details>
        <summary>Ver mensagens brutas da sess√£o (debug)</summary>
        <pre id="debug" class="small" style="white-space:pre-wrap"></pre>
      </details>
    </div>
  </div>

  <script>
    // ==========================================================
    // AVISO IMPORTANTE (leia):
    // Este exemplo chama a API OpenAI direto do navegador, para fins did√°ticos.
    // NUNCA exponha sua chave em produ√ß√£o. Em produ√ß√£o, implemente um PROXY no seu backend
    // (ex.: /api/chat) e fa√ßa o fetch para esse endpoint (ver coment√°rios abaixo).
    // ==========================================================

    const el = (id)=>document.getElementById(id);
    const log = el('log');
    const debug = el('debug');
    const state = { messages: [] };

    el('temp').addEventListener('input', (e)=>{
      el('tempv').textContent = e.target.value;
    });

    document.addEventListener('keydown', (e)=>{
      if((e.ctrlKey || e.metaKey) && e.key === 'Enter') send();
    });

    el('send').addEventListener('click', send);
    el('clear').addEventListener('click', ()=>{ state.messages=[]; log.innerHTML=''; debug.textContent=''; });

    function appendMessage(role, text){
      const wrap = document.createElement('div');
      wrap.className = 'msg';
      const who = document.createElement('div');
      who.className = 'badge';
      who.textContent = role === 'user' ? 'Voc√™' : (role === 'system' ? 'Sistema' : 'GPT');
      const content = document.createElement('div');
      content.className = 'content';
      content.textContent = text;
      wrap.appendChild(who); wrap.appendChild(content);
      log.appendChild(wrap); log.scrollTop = log.scrollHeight;
    }

    async function send(){
      const model = el('model').value;
      const temperature = parseFloat(el('temp').value);
      const system = el('system').value.trim();
      const userText = el('userText').value.trim();
      if(!userText){ return; }

      // Atualiza hist√≥rico local
      if(system && state.messages.length===0){
        state.messages.push({ role:'system', content: system });
        appendMessage('system', system);
      }
      state.messages.push({ role:'user', content: userText });
      appendMessage('user', userText);
      el('userText').value='';

      // Cria espa√ßo para a resposta em streaming
      const partial = document.createElement('div');
      partial.className = 'msg';
      partial.innerHTML = '<div class="badge">GPT</div><div class="content" id="stream"></div>';
      log.appendChild(partial); log.scrollTop = log.scrollHeight;
      const streamEl = partial.querySelector('#stream');

      try{
        el('send').disabled = true;

        // ====== ROTA DA API ======
        // Para PRODU√á√ÉO, troque por algo como:
        //   const endpoint = '/api/chat'; // seu proxy backend
        // e no backend, reencaminhe para https://api.openai.com/v1/chat/completions
        const endpoint = 'https://api.openai.com/v1/chat/completions';

        // Monta payload (Chat Completions)
        const payload = {
          model,
          messages: state.messages,
          temperature,
          stream: true
        };

        // Chamada com streaming SSE
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // Em produ√ß√£o, N√ÉO envie o Authorization do front. Mova para o backend proxy.
            'Authorization': `Bearer`
          },
          body: JSON.stringify(payload)
        });

        if(!res.ok){
          const txt = await res.text();
          throw new Error('HTTP '+res.status+': '+txt);
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let full = '';

        while(true){
          const { value, done } = await reader.read();
          if(done) break;
          const chunk = decoder.decode(value, {stream:true});
          // protocolo SSE: linhas come√ßando com "data: "
          const lines = chunk.split('\n');
          for(const line of lines){
            const trimmed = line.trim();
            if(!trimmed.startsWith('data:')) continue;
            const data = trimmed.replace(/^data:\s*/, '');
            if(data === '[DONE]') continue;
            try{
              const json = JSON.parse(data);
              const delta = json.choices?.[0]?.delta?.content || '';
              if(delta){
                full += delta;
                streamEl.textContent = full;
                log.scrollTop = log.scrollHeight;
              }
            }catch(err){ /* chunks de keep-alive etc. */ }
          }
        }

        state.messages.push({ role:'assistant', content: full });
        debug.textContent = JSON.stringify({ request: payload, response: full.slice(0,2000) + (full.length>2000?'‚Ä¶':'') }, null, 2);
      }catch(err){
        const e = document.createElement('div');
        e.className = 'small danger';
        e.textContent = 'Erro: '+ (err?.message || err);
        log.appendChild(e);
      }finally{
        el('send').disabled = false;
      }
    }
  </script>

  <!-- ================= BACKEND PROXY (EXEMPLO) =================
  // Use isso NO SERVIDOR (Node/Express). N√£o coloque a chave no front.
  // server.js
  //   import express from 'express'
  //   import fetch from 'node-fetch'
  //   const app = express(); app.use(express.json());
  //   app.post('/api/chat', async (req,res)=>{
  //     const r = await fetch('https://api.openai.com/v1/chat/completions',{
  //       method:'POST',
  //       body: JSON.stringify({ ...req.body, stream:true })
  //     });
  //     // Encaminha SSE para o cliente
  //     res.setHeader('Content-Type','text/event-stream');
  //     r.body.pipe(res);
  //   });
  //   app.listen(8787)
  // No HTML acima, troque o endpoint por '/api/chat' e REMOVA o header Authorization do front.
  // ============================================================= -->
</body>
</html>
